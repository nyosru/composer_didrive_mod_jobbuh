{% spaceless %}

    <style>
        div sup{ color: rgba(0,0,0,0.05); }
        div:HOVER > sup{ color: rgba(0,0,0,0.5); }
        .sup_hover_gray sup{ color: rgba(0,0,0,0.3); }
        .sup_hover_gray:HOVER > sup.gray{ color: rgba(0,0,0,0.7); }
    </style>

    {% set sps = items__get( db, 'sale_point' )  %}    
    {#{ pa(sps) }#} 

    {% set dolgns = readItems( '061.dolgnost', null )  %}
    {#{ pa(dolgns.data,2) }#}

    {% set date_start = get.d_start %}
    {% set date_finish = get.d_fin %}

    {% set getListJobsPeriodAll = jobdesc__getListJobsPeriodAll( db, date_start, date_finish ) %}
    {# весь массив данных по этому месяцу #}
    {#{ pa(getListJobsPeriodAll,2) }#}
    {# список сотрудников работающих на точках в этом месяце #}
    {#{ pa(getListJobsPeriodAll.data.job_on_sp) }#}
    {# список сотрудников работающих на точке в этом месяце #}
    {#{ pa(getListJobsPeriodAll.data.job_on_sp[get.sp],2) }#}

    {% if get.sp is defined and getListJobsPeriodAll.data.job_on_sp[get.sp] is defined %}

        {# показ таблицы с данными #}

        {# таблицы если выбрана дата показа #}

        <div class="row" style="margin-top:20px; margin-bottom:20px;">

            <div class="col-xs-12 col-xl-12 text-center">
                <h3>Зарплатная ведомость №{{get.sp}}/{{ "now"|date('ymd') }}</h3>
                <p>
                    Точка продаж: {{ sps[get.sp]['head'] }}
                    <br/>Расчётный период: {{ get.d_start|date('d.m.Y') }} - {{ get.d_fin|date('d.m.Y') }}
                    <br/>Дата составления: {{ "now"|date('d.m.Y H:i') }}
                </p>
            </div>

        </div>

        <div class="row">
            <div class="col-xs-12 col-xl-12">

                {#{ pa(sps) }#}

                <style>
                    {#.t11, 
                    .t11 tr, 
                    .t11 td, 
                    .t11 th, 
                    .t11 thead,
                    .t11 tbody
                    { border:1px solid black; }#}
                    .t11 thead{
                        background-color: rgba(0,0,0,0.05);
                    }
                </style>

                <table class="table border-black table-bordered t11" >

                    <thead>
                        <tr>
                            <Th>ФИО</th>
                            <th>Начислено&nbsp;(₽)</th>

                            {# <th>Аванс на&nbsp;карту&nbsp;(₽)</th> #}
                            <th>Вознаграждение&nbsp;(₽)</th>
                                {# <th>НДФЛ</th> #}
                            <th>Взыскания&nbsp;(₽)</th>

                            <th>Сумма к&nbsp;выдаче&nbsp;₽</th>
                            <th>Личная подпись</th>
                        </tr>
                    </thead>
                    <tbody>


                        {# спец назначения #}
                        {#{  pa(getListJobsPeriodAll.data.spec.data,2) }#}

                        {# расклад по работе сотрудников кто где #}
                        {#{ pa(getListJobsPeriodAll.data.where_job__workman_date,2) }#}

                        {% for man_id, man in getListJobsPeriodAll.data.job_on_sp[get.sp] %}

                            {% set summa_man = 0 %}

                            <tr>

                                <td>

                                    {## % include '/vendor/didrive_mod/job_buh/1/didrive/tpl/body.print.tables.user_line.htm' %#}
                                    {{ man['fio2'] ?? man['fio'] }}
                                    {#{ pa(man) }#}

                                </td>

                                {#% include '/vendor/didrive_mod/job_buh/1/didrive/tpl/body.tables.user.htm' %#}
                                {#{ pa(getListJobsPeriodAll.data.checks,2) }#}

                                {# getListJobsPeriodAll.data.checks {{ pa(getListJobsPeriodAll.data.checks) }} #}

                                {% for dd in range(0,32) %}

                                    {#{ date_start|date_modify('+'~dd~' day')|date('Y-m-d') }#}
                                    {% set run_date = date_start|date_modify('+'~dd~' day')|date('Y-m-d') %}
                                    {# + {{ run_date }} #}

                                    {# список смен и начислений и взысканий #}
                                    {% set date_last = '' %}

                                    {% set payed_man = 0 %}
                                    {% set stopline = false %}
                                    {#{ pa(checks['days']) }#}

                                    {% for check_id, item in getListJobsPeriodAll.data.checks if item.jobman == man_id and item.start|date('Y-m-d') == run_date %}

                                        {#{ pa(item) }#}
                                        {%  set now_day_job = getListJobsPeriodAll.data.where_job__workman_date[man_id][run_date] %}
                                        {#%  set now_day_job = getListJobsPeriodAll.data.where_job__workman_date[man_id][item.start|date('Y-m-d')] %#}
                                        {#{ pa(now_day_job) }#}

                                        {%  if now_day_job.sale_point is defined and get.sp is defined and now_day_job.sale_point == get.sp %}
                                            {% include '/vendor/didrive_mod/job_buh/1/didrive/tpl/body.print.tables.user.smena.htm' %}
                                        {% endif %}

                                    {% endfor %}


                                    {% if 1 == 2 %}
                                        {% for id, item in getListJobsPeriodAll.data.money_bonus if item.jobman == man_id and item.date_now == run_date and item.sale_point == get.sp and get.sp is defined %}

                                            {#{ pa(item) }#}
                                            {## % include '/vendor/didrive_mod/job_buh/1/didrive/tpl/body.print.tables.user.bonus.htm' % #}

                                        {% endfor %}

                                        {% for id, item in getListJobsPeriodAll.data.money_minus if item.jobman == man_id and item.date_now == run_date and item.sale_point == get.sp and get.sp is defined %}

                                            {#{ pa(item) }#}
                                            {## % include '/vendor/didrive_mod/job_buh/1/didrive/tpl/body.print.tables.user.minus.htm' % #}

                                        {% endfor %}
                                    {% endif %}

                                {% endfor %}

                                {#% include '/vendor/didrive_mod/job_buh/1/didrive/tpl/body.print.tables.user_bottom_line.htm' %#}

                                {% set summa_man = getListJobsPeriodAll.data.money_to_pay[get.sp][man_id] %}

                                {#{ summa_man|number_format(0, '.', '`') }#}

                                {% if 1 == 2 %}
                            <div class="text-left" >
                                {{ pa(summa_man,2) }}
                            </div>
                        {% endif %}

                        {% set buh_pm_cfg = get_buh_PM_cfg() %}

                        {% if 1 == 2 %}
                            <div class="text-left" >
                                {{ pa(buh_pm_cfg,2) }}
                            </div>
                        {% endif %}

                        {% set pm_user = job_buh__get_buh_PM(db,get.d_start,man_id) %}

                        {% if 1 == 2 %}
                            <div class="text-left" >
                                {{ pa(pm_user,2) }}
                            </div>
                        {% endif %}

                        <td class="text-right">

                            {{ summa_man|number_format(2, '.', '`') }}

                            {% set show_dop = 0 %}
                            {% set show_dop2 = 0 %}

                            {% for k7, pay in getListJobsPeriodAll.data.oplats if pay.jobman == man_id and pay.sale_point == get.sp and pay.summa is defined and pay.date_end_period is defined and pay.date_end_period >= get.d_start  and pay.date_end_period <= get.d_fin %}

                                {% if show_dop2 == 0 %}

                                    {% set show_dop2 = 1 %}

                                    {% if show_dop == 0 %}
                                        <small>
                                        {% endif %}
                                        <br/>Произведённые выплаты:
                                    {% endif %}

                                    <br/>{{ pay.date ?? '' }} / {{ pay.summa|number_format(2,'.','`') }}
                                    {% set summa_man = summa_man - pay.summa %}

                                {% endfor %}

                                {% if 1 == 2 %}
                                </small>
                            {% endif %}

                        </td>

                        {# плюсы #}
                        <td class="text-right" style="padding:0;">

                            <table class="table table-sm" >
                                {% for k,v in buh_pm_cfg.plus if k != 'skip' and pm_user[k]['summa'] is defined %}

                                    <tr>
                                        <td>
                                            {{ v }}
                                        </td>
                                        <td>
                                            {{ pm_user[k]['summa']|number_format(2,'.','`') }}
                                            {% set summa_man = summa_man + pm_user[k]['summa'] %}
                                        </td>
                                    </tr>

                                {% endfor %}
                            </table>            


                        </td>

                        {# взыскания #}
                        <td class="text-right" style="padding:0;">

                            <table class="table table-sm" >
                                {% for k,v in buh_pm_cfg.minus if k != 'skip' and pm_user[k]['summa'] is defined %}
                                    <tr>
                                        <td>
                                            {{ v }}
                                        </td>
                                        <td>
                                            {{ pm_user[k]['summa']|number_format(2,'.','`') }}
                                            {% set summa_man = summa_man - pm_user[k]['summa'] %}
                                        </td>
                                    </tr>
                                {% endfor %}
                            </table>            

                        </td>

                        <td class="text-right">

                            {% if get.d_fin|date('d') == 20 %}

                                {% set summa90 = summa_man/100*90 %}
                                {#% set summa_all = summa90 - ( pm_user['avans_on_karta']['summa'] ?? 0 ) - ( pm_user['ndfl']['summa'] ?? 0 ) %#}
                                {% set summa_all = summa90 %}
                                {% set a22 = summa_all/100 %}
                                {% set a1 = a22|round(0,'floor')*100 %}

                            {% else %}

                                {% set a1 = summa_man %}

                            {% endif %}

                            {{ a1|number_format(2, '.', '`') }}

                        </td>

                        <td>
                            &nbsp;
                        </td>

                        </tr>

                    {% endfor %}

                    </tbody>
                </table>

            {% endif %}

        {% endspaceless %}
