{% spaceless %}

    <style>
        div sup{ color: rgba(0,0,0,0.05); }
        div:HOVER > sup{ color: rgba(0,0,0,0.5); }
        .sup_hover_gray sup{ color: rgba(0,0,0,0.3); }
        .sup_hover_gray:HOVER > sup.gray{ color: rgba(0,0,0,0.7); }
    </style>


    {% set sps = items__get( db, 'sale_point' )  %}    
    {#{ pa(sps) }#} 

    {% set dolgns = readItems( '061.dolgnost', null )  %}
    {#{ pa(dolgns.data,2) }#}

    {% set date_start = get.d_start %}
    {% set date_finish = get.d_fin %}

    {% set getListJobsPeriodAll = jobdesc__getListJobsPeriodAll( db, date_start, date_finish ) %}
    {# весь массив данных по этому месяцу #}
    {#{ pa(getListJobsPeriodAll,2) }#}
    {# список сотрудников работающих на точках в этом месяце #}
    {#{ pa(getListJobsPeriodAll.data.job_on_sp) }#}
    {# список сотрудников работающих на точке в этом месяце #}
    {#{ pa(getListJobsPeriodAll.data.job_on_sp[get.sp],2) }#}

    {% if get.sp is defined and getListJobsPeriodAll.data.job_on_sp[get.sp] is defined %}

        {# показ таблицы с данными #}


        {# таблицы если выбрана дата показа #}

        <div class="row" style="margin-top:20px; margin-bottom:20px;">

            <div class="col-xs-12 col-xl-12 text-center">
                <h3>Зарплатная ведомость №{{get.sp}}/{{ "now"|date('ymd') }}</h3>
                <p>
                    Точка продаж: {{ sps[get.sp]['head'] }}
                    <br/>Расчётный период: {{ get.d_start|date('d.m.Y') }} - {{ get.d_fin|date('d.m.Y') }}
                    <br/>Дата составления: {{ "now"|date('d.m.Y H:i') }}
                </p>
            </div>

        </div>
            
        <div class="row">
            <div class="col-xs-12 col-xl-12">

                {#{ pa(sps) }#}

                <table class="table table-bordered" >

                    <thead>
                        <tr>
                            <Th>ФИО</th>
                            <th>Начислено</th>
                            <th>Аванс на карту</th>
                            <th>НДФЛ</th>
                            <th>Сумма к&nbsp;выдаче&nbsp;₽</th>
                            <th>Личная подпись</th>
                        </tr>
                    </thead>
                    <tbody>


                        {# спец назначения #}
                        {#{  pa(getListJobsPeriodAll.data.spec.data,2) }#}

                        {# расклад по работе сотрудников кто где #}
                        {#{ pa(getListJobsPeriodAll.data.where_job__workman_date,2) }#}

                        {% for man_id, man in getListJobsPeriodAll.data.job_on_sp[get.sp] %}

                            {% set summa_man = 0 %}

                            <tr>

                                <td>

                                    {## % include '/vendor/didrive_mod/job_buh/1/didrive/tpl/body.print.tables.user_line.htm' %#}
                                    {{ man['fio2'] ?? man['fio'] }}
                                    {#{ pa(man) }#}

                                </td>

                                {#% include '/vendor/didrive_mod/job_buh/1/didrive/tpl/body.tables.user.htm' %#}
                                {#{ pa(getListJobsPeriodAll.data.checks,2) }#}

                                {# getListJobsPeriodAll.data.checks {{ pa(getListJobsPeriodAll.data.checks) }} #}

                                {% for dd in range(0,32) %}

                                    {#{ date_start|date_modify('+'~dd~' day')|date('Y-m-d') }#}
                                    {% set run_date = date_start|date_modify('+'~dd~' day')|date('Y-m-d') %}
                                    {# + {{ run_date }} #}

                                    {# список смен и начислений и взысканий #}
                                    {% set date_last = '' %}

                                    {% set payed_man = 0 %}
                                    {% set stopline = false %}
                                    {#{ pa(checks['days']) }#}

                                    {% for check_id, item in getListJobsPeriodAll.data.checks if item.jobman == man_id and item.start|date('Y-m-d') == run_date %}

                                        {#{ pa(item) }#}
                                        {%  set now_day_job = getListJobsPeriodAll.data.where_job__workman_date[man_id][run_date] %}
                                        {#%  set now_day_job = getListJobsPeriodAll.data.where_job__workman_date[man_id][item.start|date('Y-m-d')] %#}
                                        {#{ pa(now_day_job) }#}

                                        {%  if now_day_job.sale_point is defined and get.sp is defined and now_day_job.sale_point == get.sp %}
                                            {% include '/vendor/didrive_mod/job_buh/1/didrive/tpl/body.print.tables.user.smena.htm' %}
                                        {% endif %}

                                    {% endfor %}

                                    {% for id, item in getListJobsPeriodAll.data.money_bonus if item.jobman == man_id and item.date_now == run_date and item.sale_point == get.sp and get.sp is defined %}

                                        {#{ pa(item) }#}
                                        {## % include '/vendor/didrive_mod/job_buh/1/didrive/tpl/body.print.tables.user.bonus.htm' % #}

                                    {% endfor %}

                                    {% for id, item in getListJobsPeriodAll.data.money_minus if item.jobman == man_id and item.date_now == run_date and item.sale_point == get.sp and get.sp is defined %}

                                        {#{ pa(item) }#}
                                        {## % include '/vendor/didrive_mod/job_buh/1/didrive/tpl/body.print.tables.user.minus.htm' % #}

                                    {% endfor %}

                                {% endfor %}

                                    {% include '/vendor/didrive_mod/job_buh/1/didrive/tpl/body.print.tables.user_bottom_line.htm' %}
                                    
                            </tr>

                        {% endfor %}

                    </tbody>
                </table>

            {% endif %}

        {% endspaceless %}
