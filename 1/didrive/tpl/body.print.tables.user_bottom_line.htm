{% spaceless %}

    {#
    <div class="trow xstick-top3" >

        <div class="tcell" >&nbsp;</div>
        <div class="tcell" >&nbsp;</div>
        <div class="tcell summa1 text-right" >
#}

    {% set summa_man = getListJobsPeriodAll.data.money_to_pay[get.sp][man_id] %}

    {#{ summa_man|number_format(0, '.', '`') }#}

    {% if 1 == 2 %}
        <div class="text-left" >
            {{ pa(summa_man,2) }}
        </div>
    {% endif %}


    {% set buh_pm_cfg = get_buh_PM_cfg() %}

    {% if 1 == 2 %}
        <div class="text-left" >
            {{ pa(buh_pm_cfg,2) }}
        </div>
    {% endif %}

    {% set pm_user = job_buh__get_buh_PM(db,get.d_start,man_id) %}

    {% if 1 == 2 %}
        <div class="text-left" >
            {{ pa(pm_user,2) }}
        </div>
    {% endif %}






    <td class="text-right">
        {{ summa_man|number_format(0, '.', '`') }}

        {% set show_dop = 0 %}

        {# плюсы минусы #}
        {% if 1 == 1 %}

            {% for k,v in buh_pm_cfg.plus if k != 'skip' %}

                {% if pm_user[k]['summa'] is defined %}

                    {% if show_dop == 0 %}
                        {% set show_dop = 1 %}
                        <small>
                            <br/>Дополнительно:
                        {% endif %}

                        <br/>+{{ pm_user[k]['summa']|number_format(0,'.','`') }}

                        {% set summa_man = summa_man + pm_user[k]['summa'] %}

                        {% if 1 == 2 %}
                        </small>
                    {% endif %}

                {% endif %}

            {% endfor %}

            {% for k,v in buh_pm_cfg.minus if k != 'skip' %}

                {% if pm_user[k]['summa'] is defined %}

                    {% if show_dop == 0 %}
                        {% set show_dop = 1 %}
                        <small>
                            <br/>Дополнительно:
                        {% endif %}

                        <br/>-{{ pm_user[k]['summa']|number_format(0,'.','`') }}

                        {% set summa_man = summa_man - pm_user[k]['summa'] %}

                        {% if 1 == 2 %}
                        </small>
                    {% endif %}

                {% endif %}

            {% endfor %}

        {% endif %}

        {#% set ostatok = summa_man - getListJobsPeriodAll.data.money_oplats[get.sp][man_id] %#}

        {#{  pa(getListJobsPeriodAll.data.money_oplats[get.sp][man_id]) }#}

        {% if 1 == 2 %}
            <div class="text-left" >
                getListJobsPeriodAll.data.oplats
                {{ pa(getListJobsPeriodAll.data.oplats) }}
            </div>
        {% endif %}



        {% set show_dop2 = 0 %}

        {% for k7, pay in getListJobsPeriodAll.data.oplats 
            if 
                pay.jobman == man_id 
                and pay.sale_point == get.sp 
                and pay.summa is defined
                and pay.date_end_period is defined
                and pay.date_end_period >= get.d_start 
                and pay.date_end_period <= get.d_fin
        %}

        {% if show_dop2 == 0 %}
            {% set show_dop2 = 1 %}
            {% if show_dop == 0 %}
                <small>
                {% endif %}
                <br/>Произведённые выплаты:
            {% endif %}

            {#{ pa(pay) }#}

            <br/>{{ pay.date ?? '' }} / {{ pay.summa|number_format(0,'.','`') }}
            {% set summa_man = summa_man - pay.summa %}

            {% endfor %}

                {% if 1 == 2 %}
                </small>
            {% endif %}

        </td>

        <td class="text-right">
            {% if pm_user['avans_on_karta']['summa'] is defined %}
                {{ pm_user['avans_on_karta']['summa']|number_format(0, '.', '`') }}
            {% else %}
                -
            {% endif %}

            {#
            <div class="text-left" >
                {{ pa(pm_user,2) }}
            </div>
            #}
        </td>

        <td class="text-right">
            {% if pm_user['ndfl']['summa'] is defined %}
                {{ pm_user['ndfl']['summa']|number_format(0, '.', '`') }}
            {% else %}
                -
            {% endif %}
        </td>

        <td class="text-right">

            {% if get.d_fin|date('d') == 20 %}

                {% set summa90 = summa_man/100*90 %}
                {#% set summa_all = summa90 - ( pm_user['avans_on_karta']['summa'] ?? 0 ) - ( pm_user['ndfl']['summa'] ?? 0 ) %#}
                {% set summa_all = summa90 %}
                {% set a22 = summa_all/100 %}
                {% set a1 = a22|round(0,'floor')*100 %}

            {% else %}

                {% set a1 = summa_man %}

            {% endif %}

            {{ a1|number_format(0, '.', '`') }}

        </td>

        <td></td>

        {% if 1 == 2 %}

            {#
                        <br/>
                        <br/>
                        <button class="btn btn-xs btn-light send-pay-good" 
                                val-summa="{{ ostatok }}" 
                                val-checkin="{{ d.id_check }}"
                                show_on_click="res{{ d.id_check }}"
                                resto="res{{ d.id_check }}"
                                >Оплатить остаток</button>
                        <div id="res{{ d.id_check }}" ></div>
            #}

            {#
                    </div>
                    <div class="tcell plategi text-right" >
            #}
            {% set ostatok = summa_man - getListJobsPeriodAll.data.money_oplats[get.sp][man_id] %}

            {#{  pa(getListJobsPeriodAll.data.money_oplats[get.sp][man_id]) }#}

            {% for k51, pay in getListJobsPeriodAll.data.oplats if pay.jobman == man_id and pay.sale_point == get.sp %}
                {#{ pa(pay) }#}

                {{ pay.summa|number_format(0, '.', '`') }} <sup>{{ pay.date }}</sup><br/>

                {#% set ostatok = ostatok - pay.summa %#}
            {% endfor %}

            {% if show_for_user_pay == true %}

                {# форма фиксации оплаты #}
                {% if 1 == 2 %}

                    {% if get.sp is not defined or ( get.sp is defined and get.sp == 'all' ) %}

                        для зачисления оплаты, выберите точку продаж

                    {% else %}

                        <br/>
                        <a href="#" 
                           id="nadpis_form_send_money_{{ man_id }}"
                           onclick="$('#form_send_money_{{ man_id }}').show('slow');
                                   $(this).hide('slow');
                                   return false;"><span class="fa fa-plus" ></span> добавить выплату</a>
                        <center>
                            <form 
                                action=""
                                method="post"
                                class="send-pay-form"
                                id="form_send_money_{{ man_id }}" 
                                style=" display:none; background-color:rgba(0,0,255,0.2);
                                padding: 5px 10px; width:200px; border-radius:15px; text-align:center;"

                                {# если есть "ajax" то передаётся в форму ajax_resto_id="res_form_add_{{ jobman }}" #}
                                {# куда печатаем результат#}
                                resto_id="res_form_add_{{ man_id }}"

                                >

                                добавить выплату

                                <div class="input-group" >
                                    <div class="input-group-prepend">
                                        <span class="input-group-text" id="inputGroupPrepend">дата</span>
                                    </div>
                                    <input type="date" class="form-control" xstyle="padding:3px;"
                                           name="date" 
                                           {%  if "now"|date('Y-m-d') >= get.d_start|date('Y-m-d') and "now"|date('Y-m-d') <= get.d_fin|date('Y-m-d') %}
                                               value="{{ "now"|date('Y-m-d') }}" 
                                           {%  else %}
                                               value="{{ get.d_fin|date('Y-m-d') }}" 
                                           {% endif %}
                                           min="{{ get.d_start|date('Y-m-d') }}" max="{{ get.d_fin|date('Y-m-d') }}" 
                                           required="required"
                                           />

                                </div>

                                <div class="input-group" >

                                    <input 
                                        type="number" min="1" max="{{ ostatok }}" 
                                        name="summa"
                                        value="{{ ostatok }}" class="form-control"  
                                        required="required"
                                        > 

                                    <div class="input-group-prepend">
                                        <span class="input-group-text" id="inputGroupPrepend">₽</span>
                                    </div>

                                </div>

                                <input type="hidden" name="sale_point" value="{{ get.sp }}" />

                                <input type="hidden" name="jobman" value="{{ man_id }}" />
                                <input type="hidden" name="id" value="{{ man_id }}" />
                                <input type="hidden" name="s" value="{{ creatSecret(man_id) }}" />

                                <input type="submit" class="xform-control xbtn-xs btn btn-success" value="Выплачено" />

                            </form>
                        </center>
                        <div id="res_form_add_{{ man_id }}-2"></div>
                        <div id="res_form_add_{{ man_id }}"></div>

                    {% endif %}

                {% endif %}                                

            {%  endif %}

            {#
        </div>
        <div class="tcell ostatki {% if ostatok == 0 %} bg-success {% else %} bg-warning {% endif %}" >
    #}


            {% if ostatok == 0 %}

                {#
                <center title="всё оплачено" class="text-white" >
                    оплачено
                </center>
                #}

            {% else %}

                {#% if show_for_user_pay == true %}
                    <a href="#" 
                       onclick="$('#nadpis_form_send_money_{{ man_id }}').hide();$('#form_send_money_{{ man_id }}').show('slow');$('#form_send_money_{{ man_id }} input[name=summa]').val('{{ ostatok }}');
                               return false;">
                        {{ ostatok|number_format(0, '.', '`') }}
                    </a>
                {% else %}
                    {{ ostatok|number_format(0, '.', '`') }}
                {% endif %#}

            {% endif %}


            {#
                    </div>
                </div>
            #}

        {% endif %}

        {% endspaceless %}