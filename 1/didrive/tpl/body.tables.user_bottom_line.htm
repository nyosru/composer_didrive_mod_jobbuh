{% spaceless %}

    <div class="trow xstick-top3" >

        <div class="tcell" >&nbsp;</div>
        <div class="tcell summa1 text-left" >

            {% set pm_user = job_buh__get_buh_PM(db,get.d_start,man_id) %}
            {#{ pa(pm_user) }#}

            {#{ pa(buh_pm_cfg) }#}


            {% set diff_summ = 0 %}


            <div class="container-fluid" >
                <div class="row" >
                    <div class="col-xs-12 col-sm-6" style="font-size:10px;">

                        {% if now_level.type2 is defined and now_level.type2 == 'buh' %}
                            <div xclass="bg-warning" style="background-color: rgba(0,255,0,0.2); padding:10px;" >
                                плюс</div>
                            {% endif %}

                        {% for k,v in buh_pm_cfg.plus if k != 'skip' %}

                            {% set diff_summ = diff_summ + ( pm_user[k]['summa'] ?? 0 ) %}

                            {% if now_level.type2 is defined and now_level.type2 == 'buh' %}

                                <div>
                                    <input type="number" 
                                           class="items__newedit_dop_pole"

                                           step="0.01"
                                           min="1"
                                           max="99999"

                                           placeholder=""
                                           value="{{ pm_user[k]['summa'] ?? '' }}"

                                           items_module="003_money_buh_pm"
                                           edit_item_id="{{ pm_user[k]['id'] ?? '' }}"
                                           edit_dop_name="summa"

                                           addpole1 = "jobman"
                                           addpole1val = "{{ man_id }}"
                                           addpole2 = "date"
                                           addpole2val = "{{ get.d_start }}"
                                           {# addpole3 = "type_minus" #}
                                           addpole3 = "type_plus"
                                           addpole3val = "{{ k }}"

                                           s="{{ creatSecret( ( pm_user[k]['id'] ?? '' )~"summa"~( man_id ?? '' )~( get.d_start ?? '' )~( k ?? '' ) ) }}"

                                           style="xfloat:left; xmargin-bottom:10px; width: 80px;"

                                           >
                                    {{ v }}                                
                                </div>
                                {#<br clear="all" />#}

                            {% else %}
                                {% if pm_user[k]['summa'] is defined and pm_user[k]['summa'] > 0 %}
                                    <b>{{ pm_user[k]['summa']|number_format(0, '.', '`') }}р</b> {{ v }}<br/>
                                {% endif %}
                            {% endif %}

                        {% endfor %}
                    </div>

                    <div class="col-xs-12 col-sm-6" style="font-size:10px;">

                        {% if now_level.type2 is defined and now_level.type2 == 'buh' %}
                            <div xclass="bg-warning" style="background-color: rgba(255,0,0,0.2); padding:10px;" >
                                взыскания</div>
                            {% endif %}

                        {% for k,v in buh_pm_cfg.minus if k != 'skip' %}

                            {% set diff_summ = diff_summ - ( pm_user[k]['summa'] ?? 0 ) %}


                            {% if now_level.type2 is defined and now_level.type2 == 'buh' %}
                                <div>
                                    <input type="number" 
                                           class="items__newedit_dop_pole"

                                           step="0.01"
                                           min="1"
                                           max="99999"

                                           placeholder=""
                                           value="{{ pm_user[k]['summa'] ?? '' }}"

                                           items_module="003_money_buh_pm"
                                           edit_item_id="{{ pm_user[k]['id'] ?? '' }}"
                                           edit_dop_name="summa"

                                           addpole1 = "jobman"
                                           addpole1val = "{{ man_id }}"
                                           addpole2 = "date"
                                           addpole2val = "{{ get.d_start }}"
                                           addpole3 = "type_minus"
                                           {# addpole3 = "type_plus" #}
                                           addpole3val = "{{ k }}"

                                           s="{{ creatSecret( ( pm_user[k]['id'] ?? '' )~"summa"~( man_id ?? '' )~( get.d_start ?? '' )~( k ?? '' ) ) }}"

                                           style="xfloat:left; xmargin-bottom:10px; width: 80px;"

                                           >
                                    {{ v }}
                                </div>
                            {% else %}
                                {% if pm_user[k]['summa'] is defined and pm_user[k]['summa'] > 0 %}
                                    <b>{{ pm_user[k]['summa']|number_format(0, '.', '`') }}р</b> {{ v }}<br/>
                                {% endif %}
                            {% endif %}
                        {% endfor %}
                    </div>
                </div>
            </div>

        </div>

        <div class="tcell summa1 text-right" >

            {% set summa_man = getListJobsPeriodAll.data.money_to_pay[get.sp][man_id] + diff_summ %}
            {{ summa_man|number_format(0, '.', '`') }}

            {#
                        <br/>
                        <br/>
                        <button class="btn btn-xs btn-light send-pay-good" 
                                val-summa="{{ ostatok }}" 
                                val-checkin="{{ d.id_check }}"
                                show_on_click="res{{ d.id_check }}"
                                resto="res{{ d.id_check }}"
                                >Оплатить остаток</button>
                        <div id="res{{ d.id_check }}" ></div>
            #}


        </div>
        <div class="tcell plategi text-right" >

            {% set ostatok = summa_man - getListJobsPeriodAll.data.money_oplats[get.sp][man_id] %}

            {#{  pa(getListJobsPeriodAll.data.money_oplats[get.sp][man_id]) }#}

            {% for k51, pay in getListJobsPeriodAll.data.oplats if pay.jobman == man_id and pay.sale_point == get.sp %}
                {#{ pa(pay) }#}
                {{ pay.summa|number_format(0, '.', '`') }} <sup>{{ pay.date }}</sup><br/>
                {#% set ostatok = ostatok - pay.summa %#}
            {% endfor %}

            {% if show_for_user_pay == true %}

                {# форма фиксации оплаты #}
                {% if 1 == 1 %}

                    {% if get.sp is not defined or ( get.sp is defined and get.sp == 'all' ) %}

                        для зачисления оплаты, выберите точку продаж

                    {% else %}

                        <br/>
                        <a href="#" 
                           id="nadpis_form_send_money_{{ man_id }}"
                           onclick="$('#form_send_money_{{ man_id }}').show('slow');
                                   $(this).hide('slow');
                                   return false;"><span class="fa fa-plus" ></span> добавить выплату</a>
                        <center>
                            <form 
                                action=""
                                method="post"
                                class="send-pay-form"
                                id="form_send_money_{{ man_id }}" 
                                style=" display:none; background-color:rgba(0,0,255,0.2);
                                padding: 5px 10px; width:200px; border-radius:15px; text-align:center;"

                                {# если есть "ajax" то передаётся в форму ajax_resto_id="res_form_add_{{ jobman }}" #}
                                {# куда печатаем результат#}
                                resto_id="res_form_add_{{ man_id }}"

                                >

                                добавить выплату

                                <div class="input-group" >
                                    <div class="input-group-prepend">
                                        <span class="input-group-text" id="inputGroupPrepend">дата</span>
                                    </div>
                                    <input type="date" class="form-control" xstyle="padding:3px;"
                                           name="date" 
                                           {%  if "now"|date('Y-m-d') >= get.d_start|date('Y-m-d') and "now"|date('Y-m-d') <= get.d_fin|date('Y-m-d') %}
                                               value="{{ "now"|date('Y-m-d') }}" 
                                           {%  else %}
                                               value="{{ get.d_fin|date('Y-m-d') }}" 
                                           {% endif %}
                                           min="{{ get.d_start|date('Y-m-d') }}" max="{{ get.d_fin|date('Y-m-d') }}" 
                                           required="required"
                                           />

                                </div>

                                <div class="input-group" >

                                    <input 
                                        type="number" min="1" max="{{ ostatok }}" 
                                        name="summa"
                                        value="{{ ostatok }}" class="form-control"  
                                        required="required"
                                        > 

                                    <div class="input-group-prepend">
                                        <span class="input-group-text" id="inputGroupPrepend">₽</span>
                                    </div>

                                </div>

                                <input type="hidden" name="sale_point" value="{{ get.sp }}" />

                                <input type="hidden" name="jobman" value="{{ man_id }}" />
                                <input type="hidden" name="id" value="{{ man_id }}" />
                                <input type="hidden" name="s" value="{{ creatSecret(man_id) }}" />

                                <input type="submit" class="xform-control xbtn-xs btn btn-success" value="Выплачено" />

                            </form>
                        </center>
                        <div id="res_form_add_{{ man_id }}-2"></div>
                        <div id="res_form_add_{{ man_id }}"></div>

                    {% endif %}

                {% endif %}                                

            {%  endif %}

        </div>

        <div class="tcell ostatki {% if ostatok == 0 %} bg-success {% else %} bg-warning {% endif %}" >

            {% if ostatok == 0 %}

                <center title="всё оплачено" class="text-white" >
                    оплачено
                </center>

            {% else %}

                {% if show_for_user_pay == true %}
                    <a href="#" 
                       onclick="$('#nadpis_form_send_money_{{ man_id }}').hide();$('#form_send_money_{{ man_id }}').show('slow');$('#form_send_money_{{ man_id }} input[name=summa]').val('{{ ostatok }}');
                               return false;">
                        {{ ostatok|number_format(0, '.', '`') }}
                    </a>
                {% else %}
                    {{ ostatok|number_format(0, '.', '`') }}
                {% endif %}

            {% endif %}

        </div>
    </div>

{% endspaceless %}